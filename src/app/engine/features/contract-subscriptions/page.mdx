import { Details, Callout, createMetadata } from "@doc";

export const metadata = createMetadata({
	title: "Contract Subscriptions | thirdweb Engine",
	description:
		"Subscribe to logs on any contract and query them from your app.",
});

# Contract Subscriptions

Subscribe to transaction logs and receipts on any contract and query them from your app.

A **log** is an event emitted from a successfully executed transaction. Example: a burned NFT emits a `Transfer OWNER -> 0x000...` log.

A **receipt** contains onchain details for any transaction. This may be useful for tracking onchain failures (reverted executions).

## Use cases

Your app may trigger an action when an onchain event occurs, such as:

- ETH or an ERC20 currency is transferred to or from a wallet.
- An token is minted from your NFT collection.
- An token in your NFT collection is burned or transferred.
- Metadata for an oracle contract is updated.

## Manage contract subscriptions

#### Add a contract subscription

1. Navigate to the [thirdweb dashboard](https://thirdweb.com/dashboard/engine).
1. Select **Contract Subscriptions**.
1. Select **Add Contract Subscription**

API reference: [`POST /contract/<chain>/<contract_address>/subscriptions/subscribe`](https://redocly.github.io/redoc/?url=https://demo.web3api.thirdweb.com/json#tag/Contract-Subscriptions/operation/addContractSubscription)

#### Remove a contract subscription

1. Navigate to the [thirdweb dashboard](https://thirdweb.com/dashboard/engine).
1. Select **Contract Subscriptions**.
1. Select **... > Remove** next to an existing subscription.

API reference: [`POST /contract/<chain>/<contract_address>/subscriptions/unsubscribe`](https://redocly.github.io/redoc/?url=https://demo.web3api.thirdweb.com/json#tag/Contract-Subscriptions/operation/addContractSubscription)

## Query contract subscription data

Query processed log and receipts with the following endpoints:

- Transaction logs: `GET /contract/subscriptions/logs`
- Transaction receipts: `GET /contract/subscriptions/receipts`

Paginate by cursor, block range, or timestamp range.

#### Query by cursor

Query data by the number of results.

`cursor` is optional and defaults to querying from the oldest data stored.

Example body:

```json
{
	"chainId": "8453",
	"addresses": "0x24e6B0dfFfF1817F2BC9aD1E49a7Ad3C97a849f4",
	"queryType": "cursor",
	"limit": 100,
	"cursor": "..."
}
```

#### Query by block range

Query data by the transaction block.

`toBlock` is optional and defaults to the last processed block.

Example body:

```json
{
	"chainId": "8453",
	"addresses": "0x24e6B0dfFfF1817F2BC9aD1E49a7Ad3C97a849f4",
	"queryType": "block",
	"fromBlock": 13520818,
	"toBlock": 13525741
}
```

#### Query by timestamp range

Query data by the transaction timestamp.

`toTimestamp` is optional and defaults to the current time.

Example body:

```json
{
	"chainId": "8453",
	"addresses": "0x24e6B0dfFfF1817F2BC9aD1E49a7Ad3C97a849f4",
	"queryType": "timestamp",
	"fromTimestamp": 1713828478, // in seconds
	"toTimestamp": 1713842571
}
```

#### Advanced queries

Query multiple subscriptions by providing multiple addresses, comma-separated:

```json
{
    ...
    "addresses": "0x24e6B0dfFfF1817F2BC9aD1E49a7Ad3C97a849f4,0x9ca57B9341dCB029a5b11163C9a47FB65BA6F4c3"
}
```

Filter topics by providing a list of topics:

```json
{
    ...
    "topics": ["Transfer"]
}
```

<Callout title="Not seeing data?" variant="info">

Logs and receipts are stored after a contract subscription is created for the specified chain and address.

Check the most recently indexed block on the **Contract Subscriptions** section of the [Engine dashboard](https://thirdweb.com/dashboard/engine).

</Callout>

## FAQ

#### Do contract subscriptions backfill past data?

Not at this time. This feature may be coming in a future Engine version.

#### Why use contract subscriptions instead of querying the blockchain directly?

Querying RPC nodes for onchain data is slow, unreliable, and costly at scale. RPCs have limits on the number of blocks that can be queried once. Even if your contract has low activity, your app must all blocks in your desired range to get accurate results.

Contract subscriptions allow your app to query the onchain data you care about from database, which is faster, more reliable, and less costly.

#### What is the difference between contract subscriptions and using event listeners in my web3 library?

Event listeners built into web3 libraries are appropriate to listen for real-time results without any persistence or resilience. If your backend request times out or your backend has an outage, event data is missed.

A Contract Subscription continuously poll the blockchain for logs and receipts since the last processed block and stores the results to database. Your app can rely on data to be stored eventually, even when unexpected issues with your backend, Engine, the RPC, or the blockchain occur.
